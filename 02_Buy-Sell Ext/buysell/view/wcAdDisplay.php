<?php/** * wcAdDisplay.php * * Contains presentation code for the display of a single ad. *  * Application: wikicoins.com buy/sell feature * * @package    wcAdDisplay * @author     Thomas Knierim * @copyright  (c) 2006 wikicoins.com * @version    1.0 * @see        wcBuySellPage.php * */include_once('extensions/buysell/model/wcConfig.php');global $wgDBprefix;// printf('$%.2f', $ad->ad_amount)$buysell_content .= "            <tr>              <td class=\"listcell\">  		                <table class=\"adtable\" cellspacing=0>                  <tr>		    <td id=\"opimage\">&nbsp;</td>                    <td class=\"adcell_text\">                      <span class=\"adamount\">$".round($ad->ad_amount, 2)."</span>";                        //echo $this->getWikiUserID()."==". $ad->user_id."<br>";						$wcConfigExt = new wcConfigExt();						/*if ( trim($_REQUEST["page_id"]) != "" && trim($_REQUEST["user_id"]) == "" && $this->getWikiUserID() == $superDeleter->superDeleterId) {							// $_SERVER['PHP_SELF']                            $buysell_content .= '<form action="'. $_SERVER['REQUEST_URI']. '" method="post" name="deleteAdForm" style="margin: 0px; padding: 0px">' . "\n";                            $buysell_content .= '<input type="hidden" name="buysellaction" value="deleteAd" />' . "\n";                            $buysell_content .= '<input type="hidden" name="adID" value="'. $ad->ad_id. '" />'. "\n";                            $buysell_content .= '<input type="submit" name="deleteButton" value="Delete My Ad" onclick="return confirm(\'Are you sure? Note all existing WikiSafe offers for this ad will be deleted.\');" />' . "\n";                            $buysell_content .= '</form>' . "\n";						}else*/												if( trim($_REQUEST["page_id"]) != "" && trim($_REQUEST["user_id"]) == "" && ($this->getWikiUserID() == $ad->user_id || ($superDeleter->superDeleterId && $this->getWikiUserID() == $superDeleter->superDeleterId ) ) ) {							// $_SERVER['PHP_SELF']                            $buysell_content .= '<form action="'. $_SERVER['REQUEST_URI']. '" method="post" name="deleteAdForm" style="margin: 0px; padding: 0px">' . "\n";                            $buysell_content .= '<input type="hidden" name="buysellaction" value="deleteAd" />' . "\n";                            $buysell_content .= '<input type="hidden" name="adID" value="'. $ad->ad_id. '" />'. "\n";							$user_name = "";							if($this->getWikiUserID() == $ad->user_id)							{								$user_name = "My";							}							elseif($this->getWikiUserID() == $superDeleter->superDeleterId)							{								$user_name = $ad->user_name . "'s";							}                            $buysell_content .= '<input type="submit" name="deleteButton" value="Delete ' . $user_name . ' Ad" onclick="return confirm(\'Are you sure? Note all existing WikiSafe offers for this ad will be deleted.\');" />' . "\n";                            $buysell_content .= '</form>' . "\n";                        }                        elseif (trim($_REQUEST["page_id"]) != "" && trim($_REQUEST["user_id"]) == "") {                            $buysell_content .= '<span class="advertiser">';	                        $buysell_content .= '<a href="/index.php?title=User:' . $ad->user_name . '">';                            $buysell_content .= htmlentities($ad->user_name,  ENT_COMPAT, "UTF-8");                             $buysell_content .= '</a></span>' . "\n";                        }                        elseif (trim($_REQUEST["page_id"]) == "" && trim($_REQUEST["user_id"]) != "") {                            $buysell_content .= '<span class="advertiser">';							if($this->getWikiUserID())		                        $buysell_content .= '<a href="/index.php?title=' . $ad->page_title . '">';    							else	                            $buysell_content .= '<a href="javascript: alert(\'To create an ad, first login or create an account\');">';							$buysell_content .= htmlentities(str_replace("_", " ", $ad->page_title),  ENT_COMPAT, "UTF-8");                             $buysell_content .= '</a></span>' . "\n";                        }						$buysell_content .= "                      <div class=\"adtext\">". htmlentities($ad->ad_text, ENT_COMPAT, "UTF-8") . "</div>                    </td>                    <td class=\"adcell_photo\">";                        $thumbnail = $ad->getImageBaseName() . '-1-tn.jpg';						//echo $thumbnail;						$fileExtensions = array('.jpg', '.gif', '.png', '.jpeg');						$image = $ad->getImageBaseName() . '-1';						foreach ($fileExtensions as $ext) 						{							$imageFile = wcConfig::IMAGE_UPLOAD_DIR . '/' . $image . $ext;							if (file_exists($imageFile)) 							{								$popupURL = wcConfig::IMAGE_URL . '/' . $image . $ext;							}						}						if (file_exists(wcConfig::IMAGE_UPLOAD_DIR . '/' . $thumbnail)) 						{							// $popupURL = 'imageviewer.php?item=' . $ad->getImageBaseName();							//$popupURL = 'http://wikiartworks.com/images/00000005-1.jpg';							$buysell_content .= '<table style="float: right"><tr><td class="adphotoframe">' . "\n";							$buysell_content .= '<a href="'. $popupURL. '" rel=lightbox["'.$ad->getImageBaseName().'"]>';    							$buysell_content .= '<img src="'. wcConfig::IMAGE_URL . '/' . $thumbnail. '" border="0" alt="Image" />';							$buysell_content .= '</a>' . "\n";											$fileExtensions = array('.jpg', '.gif', '.png', '.jpeg');							$image = $ad->getImageBaseName() . '-';							for($i = 2; $i <= 5; $i++) 							{								foreach ($fileExtensions as $ext) 								{									$imageFile = wcConfig::IMAGE_UPLOAD_DIR . '/' . $image.$i.$ext;									if (file_exists($imageFile)) 									{										$next = wcConfig::IMAGE_URL . '/' . $image.$i.$ext;										$buysell_content .= '<a href="'. $next. '" rel=lightbox["'.$ad->getImageBaseName().'"] style=display:none><img src="'. wcConfig::IMAGE_URL . '/' . $thumbnail. '" border="0" alt="Image" /></a>';									}								}							}						}						else 						{							$buysell_content .= '<table style="float: right"><tr><td class="ademptyframe">' . "\n";							$buysell_content .= 'No image available';						}                        $buysell_content .= '</td></tr></table> ';//'."\n";                        						if ( trim($_REQUEST["page_id"]) != "" && trim($_REQUEST["user_id"]) == "" && $this->getWikiUserID() == $ad->user_id) {							//$buysell_content .= "";							# bug # 12							$href = "javascript: alert('It seems silly to send yourself an offer.');";						}						else if (trim($_REQUEST["page_id"]) == "" && trim($_REQUEST["user_id"]) != "") {							//$buysell_content .= "";						}						elseif($this->getWikiUserID())						{							if ($user_type == "B") { 								$buyer_id=$ad->user_id;								$seller_id=$this->getWikiUserID();							}							elseif ($user_type == "S") { 								$buyer_id=$this->getWikiUserID();								$seller_id=$ad->user_id;							}														# bug # 12 - A user cannot "Make a WikiSafe Offer" twice on the same ad. If he selects the same ad, the following error message will appear:														/*$query = "select id, status from escrow_escrow 										where ad_id='" . $ad->ad_id . "' 												and escrow_prefix = '$wgDBprefix' 												and seller_id = '$seller_id' 												and buyer_id = '$buyer_id' 									 ";*/							$count = $ad->chkInitiate($ad->ad_id, $seller_id, $buyer_id);							if($count > 0)							{								$href = "javascript: alert('You have already initiated an escrow for this ad. \\nSelect &#34;my escrows&#34; to review your escrows.');";							}							else							{								$href = $wcConfigExt->escrowfolder."/status_start.php?user_type=$user_type&wgDBprefix=$wgDBprefix&seller_id=".$seller_id."&buyer_id=".$buyer_id."&ad_id=".$ad->ad_id;							}						}						else						{						  $href = "javascript: alert('To make an offer, first login or create an account');";						}						// written for # bug # 17 - The User Rating entered by the users upon completion of an escrow at pages status07.php and status11.php						$rating = "N/A";						$tempRating = $ad->getRating($ad->user_id);												if($tempRating)							$rating = round($tempRating);																			$buysell_content .= "                                           </td><td class=\"add_img1\"><img src=\"extensions/buysell/objects/al_curved_01.gif\"></td>                  </tr>                    <tr>                    <td class=\"adcell_data_curved1\"><img src='extensions/buysell/objects/adbckd_curved.gif'></td>		     <td class=\"adcell_data_curved\" align=\"center\"><div class=\"addcenter\">                      <span class=\"addata\">" . strtoupper(ereg_replace("_", "-" , $wgDBprefix)) . substr($ad->ad_id, 0, 6). "</span>                      <span class=\"addata\">User Rating: " . $rating ."</span></div>                    </td>                    <td class=\"adcell_offer\" colspan = \"2\">                      <a class=\"adcell_offer\" href=\"$href\"><span class=\"adoffer\"></span></a>                    </td>                   </tr>                </table>                            </td>            </tr>";			/*			printf('WCEG-%06d', $ad->ad_id)			*/?>